<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Examples &mdash; Flows SDK 0.6.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/autodoc_pydantic.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom_supervision.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Custom Supervision" href="custom_supervision.html" />
    <link rel="prev" title="Tutorial" href="tutorial.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Flows SDK
          </a>
              <div class="version">
                0.6.0

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction to Flows SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#hello-flow">Hello Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#idp-starter">IDP Starter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#idp-w-code-block">IDP w/ Code Block</a></li>
<li class="toctree-l2"><a class="reference internal" href="#invoice-validation">Invoice Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pdf-redaction">PDF Redaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#code-snippets">Code Snippets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-iterate-over-multiple-documents-in-a-submission">How do I iterate over multiple documents in a submission?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-compare-fields-across-different-documents">How do I compare fields across different documents?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="custom_supervision.html">Custom Supervision</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="source-docs.html">Source Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="idp_32.html">IDP Library</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Flows SDK</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Examples</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="examples">
<h1>Examples<a class="headerlink" href="#examples" title="Permalink to this headline"></a></h1>
<p>This section contains examples of fully executable flows. We recommend using one of these examples as a template for building a flow to fit your exact business process.</p>
<p>Most examples marked contain a release and/or sample documents necessary to execute the flow in your instance of the Hyperscience Platform. You can still build your own release and test with additional documents.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 24%" />
<col style="width: 38%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 19%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Release</p></th>
<th class="head"><p>Sample Docs</p></th>
<th class="head"><p>Download</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference internal" href="#hello-flow"><span class="std std-ref">Hello Flow</span></a></p></td>
<td><p>A single Code block.</p></td>
<td></td>
<td></td>
<td><p><a class="reference download internal" download="" href="../_downloads/f42e3eecbffde899bc29d261f2ac86d0/flow.py"><code class="xref download docutils literal notranslate"><span class="pre">hello_flow.py</span></code></a></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#idp-starter"><span class="std std-ref">IDP Starter</span></a></p></td>
<td><p>Basic document processing flow. Package includes release and sample documents for processing Form W-9s.</p></td>
<td><img alt="../_images/checkmark.png" class="checkmark" src="../_images/checkmark.png" />
</td>
<td><img alt="../_images/checkmark.png" class="checkmark" src="../_images/checkmark.png" />
</td>
<td><p><a class="reference download internal" download="" href="../_downloads/2279a32bac9d45ac239eeb28370e1900/idp-starter.zip"><code class="xref download docutils literal notranslate"><span class="pre">idp_starter.zip</span></code></a></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#idp-w-code-block"><span class="std std-ref">IDP w/ Code Block</span></a></p></td>
<td><p>IDP Starter + a script to modify the extracted data.</p></td>
<td></td>
<td></td>
<td><p><a class="reference download internal" download="" href="../_downloads/0b0c0cb6b7b26a2a7367f0ffc2b6482a/flow.py"><code class="xref download docutils literal notranslate"><span class="pre">idp_custom.py</span></code></a></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#invoice-validation"><span class="std std-ref">Invoice Validation</span></a></p></td>
<td><p>Validates invoice line items and the total invoice amount.</p></td>
<td><img alt="../_images/checkmark.png" class="checkmark" src="../_images/checkmark.png" />
</td>
<td><img alt="../_images/checkmark.png" class="checkmark" src="../_images/checkmark.png" />
</td>
<td><p><a class="reference download internal" download="" href="../_downloads/d13c9b2db3581c7c1719101952ebaf9f/invoice_validation_v32.zip"><code class="xref download docutils literal notranslate"><span class="pre">invoice_validation.zip</span></code></a></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#pdf-redaction"><span class="std std-ref">PDF Redaction</span></a></p></td>
<td><p>Redaction of fields in a PDF by performing REGEX on fields and blacking out the corresponding bounding box.</p></td>
<td><img alt="../_images/checkmark.png" class="checkmark" src="../_images/checkmark.png" />
</td>
<td><img alt="../_images/checkmark.png" class="checkmark" src="../_images/checkmark.png" />
</td>
<td><p><a class="reference download internal" download="" href="../_downloads/eff71ec3b851e59f841e9a7789327f57/pdf_redaction_v32.zip"><code class="xref download docutils literal notranslate"><span class="pre">pdf_redaction.zip</span></code></a></p></td>
</tr>
</tbody>
</table>
<section id="hello-flow">
<h2>Hello Flow<a class="headerlink" href="#hello-flow" title="Permalink to this headline"></a></h2>
<p>This example consists of a single Code block. It is the simplest possible executable flow.</p>
<p><a class="reference download internal" download="" href="../_downloads/f42e3eecbffde899bc29d261f2ac86d0/flow.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">hello_flow.py</span></code></a></p>
<img alt="../_images/hello_world_flow_studio.png" src="../_images/hello_world_flow_studio.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">UUID</span>

<span class="kn">from</span> <span class="nn">flows_sdk</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">flows_sdk.blocks</span> <span class="kn">import</span> <span class="n">CodeBlock</span>
<span class="kn">from</span> <span class="nn">flows_sdk.flows</span> <span class="kn">import</span> <span class="n">Flow</span><span class="p">,</span> <span class="n">Manifest</span><span class="p">,</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">flows_sdk.package_utils</span> <span class="kn">import</span> <span class="n">export_flow</span>

<span class="c1"># Flow identifiers are globally unique</span>
<span class="c1"># New versions in case of backward incompatibility are expected to have a different name</span>
<span class="c1"># (e.g. HELLO_FLOW_2).</span>
<span class="c1"># By convention, identifiers are snake-cased capital letter strings with an optional numeric suffix.</span>
<span class="n">HELLO_FLOW_IDENTIFIER</span> <span class="o">=</span> <span class="s1">&#39;HELLO_FLOW&#39;</span>

<span class="c1"># Flows should have a deterministic UUID ensuring cross-system consistency</span>
<span class="n">HELLO_FLOW_UUID</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="s1">&#39;2e3ab564-fcf5-41fb-a573-4bc2fd153b6d&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">entry_point_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">sample_flow_with_secret</span><span class="p">()</span>


<span class="c1"># Flow inputs can be referenced in blocks, so usually it is a good idea define them somewhere</span>
<span class="k">class</span> <span class="nc">FlowInputs</span><span class="p">:</span>
    <span class="n">HELLO_INPUT</span> <span class="o">=</span> <span class="s1">&#39;hello_input&#39;</span>


<span class="k">def</span> <span class="nf">sample_flow_with_secret</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">code_fn</span><span class="p">(</span><span class="n">code_block_input_param</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Hello </span><span class="si">{</span><span class="n">code_block_input_param</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="c1"># Parameters can be added to a :func:`~Flow`</span>
    <span class="n">hello_input_param</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">FlowInputs</span><span class="o">.</span><span class="n">HELLO_INPUT</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Hello input&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">ccb</span> <span class="o">=</span> <span class="n">CodeBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;hello_ccb&#39;</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="n">code_fn</span><span class="p">,</span>
        <span class="n">code_input</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;code_block_input_param&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">workflow_input</span><span class="p">(</span><span class="n">FlowInputs</span><span class="o">.</span><span class="n">HELLO_INPUT</span><span class="p">)},</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">Flow</span><span class="p">(</span>
        <span class="n">depedencies</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Hello World Flow&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A simple Flow showcasing how inputs are passed&#39;</span><span class="p">,</span>
        <span class="n">blocks</span><span class="o">=</span><span class="p">[</span><span class="n">ccb</span><span class="p">],</span>
        <span class="n">owner_email</span><span class="o">=</span><span class="s1">&#39;viktor.penelski@hyperscience.com&#39;</span><span class="p">,</span>
        <span class="n">manifest</span><span class="o">=</span><span class="n">Manifest</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="n">HELLO_FLOW_IDENTIFIER</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="n">hello_input_param</span><span class="p">]),</span>
        <span class="n">uuid</span><span class="o">=</span><span class="n">HELLO_FLOW_UUID</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">{</span><span class="n">FlowInputs</span><span class="o">.</span><span class="n">HELLO_INPUT</span><span class="p">:</span> <span class="s1">&#39;World&#39;</span><span class="p">},</span>
    <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">export_flow</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="n">entry_point_flow</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="idp-starter">
<h2>IDP Starter<a class="headerlink" href="#idp-starter" title="Permalink to this headline"></a></h2>
<p>This example is a snapshot of our V32 Intelligent Document Processing (IDP) flow. It uses both Machine and Manual blocks to:</p>
<ol class="arabic simple">
<li><p>Classify and collate pages</p></li>
<li><p>Identify and transcribe text</p></li>
<li><p>Additional manual transcription for any fields marked for review</p></li>
<li><p>Output results to a downstream system</p></li>
</ol>
<p><a class="reference download internal" download="" href="../_downloads/2279a32bac9d45ac239eeb28370e1900/idp-starter.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">idp_starter.zip</span></code></a></p>
<img alt="../_images/idp_example_flow_studio.png" src="../_images/idp_example_flow_studio.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">UUID</span>

<span class="kn">from</span> <span class="nn">flows_sdk.flows</span> <span class="kn">import</span> <span class="n">Flow</span>
<span class="kn">from</span> <span class="nn">flows_sdk.implementations.idp_v32.idp_blocks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CaseCollationBlock</span><span class="p">,</span>
    <span class="n">FlexibleExtractionBlock</span><span class="p">,</span>
    <span class="n">IDPOutputsBlock</span><span class="p">,</span>
    <span class="n">MachineClassificationBlock</span><span class="p">,</span>
    <span class="n">MachineIdentificationBlock</span><span class="p">,</span>
    <span class="n">MachineTranscriptionBlock</span><span class="p">,</span>
    <span class="n">ManualClassificationBlock</span><span class="p">,</span>
    <span class="n">ManualIdentificationBlock</span><span class="p">,</span>
    <span class="n">ManualTranscriptionBlock</span><span class="p">,</span>
    <span class="n">SubmissionBootstrapBlock</span><span class="p">,</span>
    <span class="n">SubmissionCompleteBlock</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">flows_sdk.implementations.idp_v32.idp_values</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IDPManifest</span><span class="p">,</span>
    <span class="n">IDPTriggers</span><span class="p">,</span>
    <span class="n">get_idp_wf_config</span><span class="p">,</span>
    <span class="n">get_idp_wf_inputs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">flows_sdk.package_utils</span> <span class="kn">import</span> <span class="n">export_flow</span>


<span class="k">def</span> <span class="nf">entry_point_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">idp_workflow</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">idp_workflow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">:</span>
    <span class="n">idp_wf_config</span> <span class="o">=</span> <span class="n">get_idp_wf_config</span><span class="p">()</span>

    <span class="c1"># The idp flow basically processes, modifies and propagates the submission object from</span>
    <span class="c1"># block to block</span>
    <span class="c1"># Each block&#39;s processing result is usually included in the submission object</span>

    <span class="c1"># Submission bootstrap block initializes the submission object and prepares external images</span>
    <span class="c1"># or other submission data if needed</span>
    <span class="n">submission_bootstrap</span> <span class="o">=</span> <span class="n">SubmissionBootstrapBlock</span><span class="p">(</span><span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;submission_bootstrap&#39;</span><span class="p">)</span>

    <span class="c1"># Case collation block groups files, documents and pages (from the submission) into cases</span>
    <span class="c1"># In this example, case collation block receives the submission object and the cases</span>
    <span class="c1"># information from submission bootstrap block</span>
    <span class="n">case_collation</span> <span class="o">=</span> <span class="n">CaseCollationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_collation&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.submission&#39;</span><span class="p">),</span>
        <span class="n">cases</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params.cases&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Machine classification block automatically matches documents to structured, semi-structured</span>
    <span class="c1"># or additional layouts</span>
    <span class="c1"># In this example, machine classification block receives the submission object from</span>
    <span class="c1"># case collation block</span>
    <span class="n">machine_classification</span> <span class="o">=</span> <span class="n">MachineClassificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_classification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">case_collation</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="n">rotation_correction_enabled</span><span class="o">=</span><span class="n">idp_wf_config</span><span class="o">.</span><span class="n">rotation_correction_enabled</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Manual classification block allows keyers to manually match submissions to their layouts.</span>
    <span class="c1"># Keyers may perform manual classification if machine classification cannot automatically</span>
    <span class="c1"># match a submission to a layout with high confidence</span>
    <span class="c1"># In this example, manual classification block receives the submission object from machine</span>
    <span class="c1"># classification block</span>
    <span class="n">manual_classification</span> <span class="o">=</span> <span class="n">ManualClassificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_classification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">machine_classification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Machine identification automatically identify fields and tables in the submission</span>
    <span class="c1"># In this example, machine identification block receives the submission object from manual</span>
    <span class="c1"># classification</span>
    <span class="n">machine_identification</span> <span class="o">=</span> <span class="n">MachineIdentificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_identification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">manual_classification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Manual identification allows keyers to complete field identification or table identification</span>
    <span class="c1"># tasks, where they draw bounding boxes around the contents of certain fields, table columns</span>
    <span class="c1"># or table rows. This identification process ensures that the system will be able to</span>
    <span class="c1"># transcribe the correct content in the upcoming transcription process</span>
    <span class="c1"># In this example, manual identification block receives the submission object from machine</span>
    <span class="c1"># identification</span>
    <span class="n">manual_identification</span> <span class="o">=</span> <span class="n">ManualIdentificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_identification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">machine_identification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="n">task_restrictions</span><span class="o">=</span><span class="n">idp_wf_config</span><span class="o">.</span><span class="n">manual_identification_config</span><span class="o">.</span><span class="n">task_restrictions</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Machine transcription automatically transcribes the content of your submission</span>
    <span class="c1"># In this example, machine identification block receives the submission object from manual</span>
    <span class="c1"># identification</span>
    <span class="n">machine_transcription</span> <span class="o">=</span> <span class="n">MachineTranscriptionBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_transcription&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">manual_identification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Manual transcription lets your keyers manually enter the text found in fields or tables</span>
    <span class="c1"># that could not be automatically transcribed</span>
    <span class="c1"># In this example, manual transcription block receives the submission object from machine</span>
    <span class="c1"># transcription block</span>
    <span class="n">manual_transcription</span> <span class="o">=</span> <span class="n">ManualTranscriptionBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_transcription&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">machine_transcription</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="n">supervision_transcription_masking</span><span class="o">=</span><span class="p">(</span>
            <span class="n">idp_wf_config</span><span class="o">.</span><span class="n">manual_transcription_config</span><span class="o">.</span><span class="n">supervision_transcription_masking</span>
        <span class="p">),</span>
        <span class="n">table_output_manual_review</span><span class="o">=</span><span class="p">(</span>
            <span class="n">idp_wf_config</span><span class="o">.</span><span class="n">manual_transcription_config</span><span class="o">.</span><span class="n">table_output_manual_review</span>
        <span class="p">),</span>
        <span class="n">task_restrictions</span><span class="o">=</span><span class="n">idp_wf_config</span><span class="o">.</span><span class="n">manual_transcription_config</span><span class="o">.</span><span class="n">task_restrictions</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Flexible extraction manually transcribes fields marked for review</span>
    <span class="c1"># In this example, flexible extraction block receives the submission object from manual</span>
    <span class="c1"># transcription block</span>
    <span class="n">flexible_extraction</span> <span class="o">=</span> <span class="n">FlexibleExtractionBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;flexible_extraction&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">manual_transcription</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="n">supervision_transcription_masking</span><span class="o">=</span><span class="p">(</span>
            <span class="n">idp_wf_config</span><span class="o">.</span><span class="n">flexible_extraction_config</span><span class="o">.</span><span class="n">supervision_transcription_masking</span>
        <span class="p">),</span>
        <span class="n">task_restrictions</span><span class="o">=</span><span class="n">idp_wf_config</span><span class="o">.</span><span class="n">flexible_extraction_config</span><span class="o">.</span><span class="n">task_restrictions</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Submission complete block finalizes submission processing and updates reporting data</span>
    <span class="c1"># Every flow needs a complete block because it initiates Quality Assurance tasks and</span>
    <span class="c1"># changes the submission&#39;s status to &quot;Complete&quot;</span>
    <span class="c1"># In this example, submission complete block receives the submission object from</span>
    <span class="c1"># marked_as_complete custom code block</span>
    <span class="n">submission_complete</span> <span class="o">=</span> <span class="n">SubmissionCompleteBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;complete_submission&#39;</span><span class="p">,</span> <span class="n">submission</span><span class="o">=</span><span class="n">flexible_extraction</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Output block allows users to send data extracted by this idp flow to other systems</span>
    <span class="c1"># for downstream processing</span>
    <span class="c1"># In this example, this is an empty output block that does not do anything by default</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">IDPOutputsBlock</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.submission&#39;</span><span class="p">)}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">Flow</span><span class="p">(</span>
        <span class="c1"># Flows should have a deterministic UUID ensuring cross-system consistency</span>
        <span class="n">uuid</span><span class="o">=</span><span class="n">UUID</span><span class="p">(</span><span class="s1">&#39;5d1515a9-ae37-45fc-bb03-d7dda943b60d&#39;</span><span class="p">),</span>
        <span class="n">owner_email</span><span class="o">=</span><span class="s1">&#39;zander.pease@hyperscience.com&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;IDP Starter Example (V32)&#39;</span><span class="p">,</span>
        <span class="c1"># Flow identifiers are globally unique</span>
        <span class="n">manifest</span><span class="o">=</span><span class="n">IDPManifest</span><span class="p">(</span><span class="n">flow_identifier</span><span class="o">=</span><span class="s1">&#39;IDP_V32_FLOW_EXAMPLE&#39;</span><span class="p">),</span>
        <span class="c1"># It is important to include all blocks that are instantiated here in the blocks</span>
        <span class="c1"># field and make sure they follow the order of the flow. For example, if machine</span>
        <span class="c1"># classification depends on the output of case collation, then case_collation must</span>
        <span class="c1"># come before machine_classification in this blocks array</span>
        <span class="n">blocks</span><span class="o">=</span><span class="p">[</span>
            <span class="n">submission_bootstrap</span><span class="p">,</span>
            <span class="n">case_collation</span><span class="p">,</span>
            <span class="n">machine_classification</span><span class="p">,</span>
            <span class="n">manual_classification</span><span class="p">,</span>
            <span class="n">machine_identification</span><span class="p">,</span>
            <span class="n">manual_identification</span><span class="p">,</span>
            <span class="n">machine_transcription</span><span class="p">,</span>
            <span class="n">manual_transcription</span><span class="p">,</span>
            <span class="n">flexible_extraction</span><span class="p">,</span>
            <span class="n">submission_complete</span><span class="p">,</span>
            <span class="n">outputs</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">get_idp_wf_inputs</span><span class="p">(</span><span class="n">idp_wf_config</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A basic approach to extracting information from documents.&#39;</span><span class="p">,</span>
        <span class="n">triggers</span><span class="o">=</span><span class="n">IDPTriggers</span><span class="p">(),</span>
        <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission_complete</span><span class="o">.</span><span class="n">output</span><span class="p">()},</span>
    <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">export_flow</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="n">entry_point_flow</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="idp-w-code-block">
<h2>IDP w/ Code Block<a class="headerlink" href="#idp-w-code-block" title="Permalink to this headline"></a></h2>
<p>This example is identical to the <a class="reference internal" href="#idp-starter"><span class="std std-ref">IDP Starter</span></a> example, however it includes an additional Code block to add “time completed” metadata to each document in the submission. This is an example of how Code blocks can arbitrarily modify extracted data before outputting to downstream systems.</p>
<p><a class="reference download internal" download="" href="../_downloads/0b0c0cb6b7b26a2a7367f0ffc2b6482a/flow.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">idp_custom.py</span></code></a></p>
<img alt="../_images/custom_idp_example_flow_studio.png" src="../_images/custom_idp_example_flow_studio.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">UUID</span>

<span class="kn">from</span> <span class="nn">flows_sdk.blocks</span> <span class="kn">import</span> <span class="n">CodeBlock</span>
<span class="kn">from</span> <span class="nn">flows_sdk.flows</span> <span class="kn">import</span> <span class="n">Flow</span>
<span class="kn">from</span> <span class="nn">flows_sdk.implementations.idp_v32.idp_blocks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CaseCollationBlock</span><span class="p">,</span>
    <span class="n">FlexibleExtractionBlock</span><span class="p">,</span>
    <span class="n">IDPOutputsBlock</span><span class="p">,</span>
    <span class="n">MachineClassificationBlock</span><span class="p">,</span>
    <span class="n">MachineIdentificationBlock</span><span class="p">,</span>
    <span class="n">MachineTranscriptionBlock</span><span class="p">,</span>
    <span class="n">ManualClassificationBlock</span><span class="p">,</span>
    <span class="n">ManualIdentificationBlock</span><span class="p">,</span>
    <span class="n">ManualTranscriptionBlock</span><span class="p">,</span>
    <span class="n">SubmissionBootstrapBlock</span><span class="p">,</span>
    <span class="n">SubmissionCompleteBlock</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">flows_sdk.implementations.idp_v32.idp_values</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IDPManifest</span><span class="p">,</span>
    <span class="n">IDPTriggers</span><span class="p">,</span>
    <span class="n">get_idp_wf_config</span><span class="p">,</span>
    <span class="n">get_idp_wf_inputs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">flows_sdk.package_utils</span> <span class="kn">import</span> <span class="n">export_flow</span>


<span class="k">def</span> <span class="nf">entry_point_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">idp_workflow</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">idp_workflow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">:</span>
    <span class="n">idp_wf_config</span> <span class="o">=</span> <span class="n">get_idp_wf_config</span><span class="p">()</span>

    <span class="c1"># The idp flow basically processes, modifies and propagates the submission object from</span>
    <span class="c1"># block to block</span>
    <span class="c1"># Each block&#39;s processing result is usually included in the submission object</span>

    <span class="c1"># Submission bootstrap block initializes the submission object and prepares external images</span>
    <span class="c1"># or other submission data if needed</span>
    <span class="n">submission_bootstrap</span> <span class="o">=</span> <span class="n">SubmissionBootstrapBlock</span><span class="p">(</span><span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;submission_bootstrap&#39;</span><span class="p">)</span>

    <span class="c1"># Case collation block groups files, documents and pages (from the submission) into cases</span>
    <span class="c1"># In this example, case collation block receives the submission object and the cases</span>
    <span class="c1"># information from submission bootstrap block</span>
    <span class="n">case_collation</span> <span class="o">=</span> <span class="n">CaseCollationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_collation&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.submission&#39;</span><span class="p">),</span>
        <span class="n">cases</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params.cases&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Machine classification block automatically matches documents to structured, semi-structured</span>
    <span class="c1"># or additional layouts</span>
    <span class="c1"># In this example, machine classification block receives the submission object from</span>
    <span class="c1"># case collation block</span>
    <span class="n">machine_classification</span> <span class="o">=</span> <span class="n">MachineClassificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_classification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">case_collation</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Manual classification block allows keyers to manually match submissions to their layouts.</span>
    <span class="c1"># Keyers may perform manual classification if machine classification cannot automatically</span>
    <span class="c1"># match a submission to a layout with high confidence</span>
    <span class="c1"># In this example, manual classification block receives the submission object from machine</span>
    <span class="c1"># classification block</span>
    <span class="n">manual_classification</span> <span class="o">=</span> <span class="n">ManualClassificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_classification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">machine_classification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Machine identification automatically identify fields and tables in the submission</span>
    <span class="c1"># In this example, machine identification block receives the submission object from manual</span>
    <span class="c1"># classification</span>
    <span class="n">machine_identification</span> <span class="o">=</span> <span class="n">MachineIdentificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_identification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">manual_classification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Manual identification allows keyers to complete field identification or table identification</span>
    <span class="c1"># tasks, where they draw bounding boxes around the contents of certain fields, table columns</span>
    <span class="c1"># or table rows. This identification process ensures that the system will be able to</span>
    <span class="c1"># transcribe the correct content in the upcoming transcription process</span>
    <span class="c1"># In this example, manual identification block receives the submission object from machine</span>
    <span class="c1"># identification</span>
    <span class="n">manual_identification</span> <span class="o">=</span> <span class="n">ManualIdentificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_identification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">machine_identification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Machine transcription automatically transcribes the content of your submission</span>
    <span class="c1"># In this example, machine identification block receives the submission object from manual</span>
    <span class="c1"># identification</span>
    <span class="n">machine_transcription</span> <span class="o">=</span> <span class="n">MachineTranscriptionBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_transcription&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">manual_identification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Manual transcription lets your keyers manually enter the text found in fields or tables</span>
    <span class="c1"># that could not be automatically transcribed</span>
    <span class="c1"># In this example, manual transcription block receives the submission object from machine</span>
    <span class="c1"># transcription block</span>
    <span class="n">manual_transcription</span> <span class="o">=</span> <span class="n">ManualTranscriptionBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_transcription&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">machine_transcription</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Flexible extraction manually transcribes fields marked for review</span>
    <span class="c1"># In this example, flexible extraction block receives the submission object from manual</span>
    <span class="c1"># transcription block</span>
    <span class="n">flexible_extraction</span> <span class="o">=</span> <span class="n">FlexibleExtractionBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;flexible_extraction&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">manual_transcription</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mark_as_completed</span><span class="p">(</span><span class="n">submission</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

        <span class="n">dt_completed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="n">dt_completed_fmt</span> <span class="o">=</span> <span class="n">dt_completed</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span>

        <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;documents&#39;</span><span class="p">]:</span>
            <span class="n">document</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>
            <span class="n">document</span><span class="p">[</span><span class="s1">&#39;complete_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_completed_fmt</span>

            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s1">&#39;pages&#39;</span><span class="p">]:</span>
                <span class="n">page</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;unassigned_pages&#39;</span><span class="p">]:</span>
            <span class="n">page</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>

        <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>
        <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;complete_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_completed_fmt</span>

        <span class="k">return</span> <span class="n">submission</span>

    <span class="c1"># Custom code block enables users to transform and validate extracted submission data</span>
    <span class="c1"># before Hyperscience sends it to downstream systems</span>
    <span class="c1"># In this example, user created a _mark_as_completed function to transform and validate</span>
    <span class="c1"># submission data</span>
    <span class="c1"># Notice that the _mark_as_completed function takes in a single argument which is passed</span>
    <span class="c1"># in using the code_input parameter</span>
    <span class="n">custom_code</span> <span class="o">=</span> <span class="n">CodeBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;mark_as_completed&#39;</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="n">_mark_as_completed</span><span class="p">,</span>
        <span class="n">code_input</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">flexible_extraction</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">)},</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mark As Completed&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Updated Transformed JSON to Completed State&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Submission complete block finalizes submission processing and updates reporting data</span>
    <span class="c1"># Every flow needs a complete block because it initiates Quality Assurance tasks and</span>
    <span class="c1"># changes the submission&#39;s status to &quot;Complete&quot;</span>
    <span class="c1"># In this example, submission complete block receives the submission object from</span>
    <span class="c1"># marked_as_complete custom code block</span>
    <span class="n">submission_complete</span> <span class="o">=</span> <span class="n">SubmissionCompleteBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;complete_submission&#39;</span><span class="p">,</span> <span class="n">submission</span><span class="o">=</span><span class="n">custom_code</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Output block allows users to send data extracted by this idp flow to other systems</span>
    <span class="c1"># for downstream processing</span>
    <span class="c1"># In this example, no output block is instantiated (blocks=[])</span>
    <span class="c1"># Setting up output blocks via UI and leaving this empty is recommended</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">IDPOutputsBlock</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.submission&#39;</span><span class="p">)},</span> <span class="n">blocks</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>

    <span class="c1"># Trigger block allows users to send data to idp flow via sources other than the User Interface</span>
    <span class="c1"># In this example, no trigger block is instantiated (blocks=[])</span>
    <span class="c1"># Setting up trigger blocks via UI and leaving this empty is recommended</span>
    <span class="n">triggers</span> <span class="o">=</span> <span class="n">IDPTriggers</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="p">[])</span>

    <span class="k">return</span> <span class="n">Flow</span><span class="p">(</span>
        <span class="c1"># Flows should have a deterministic UUID ensuring cross-system consistency</span>
        <span class="n">uuid</span><span class="o">=</span><span class="n">UUID</span><span class="p">(</span><span class="s1">&#39;f923871d-8742-45cd-ae6d-e0429c098421&#39;</span><span class="p">),</span>
        <span class="n">owner_email</span><span class="o">=</span><span class="s1">&#39;harry.yu@hyperscience.com&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;IDP with Custom Code Block Flow Example (V32)&#39;</span><span class="p">,</span>
        <span class="c1"># Flow identifiers are globally unique</span>
        <span class="n">manifest</span><span class="o">=</span><span class="n">IDPManifest</span><span class="p">(</span><span class="n">flow_identifier</span><span class="o">=</span><span class="s1">&#39;IDP_WITH_CUSTOM_CODE_V32_FLOW_EXAMPLE&#39;</span><span class="p">),</span>
        <span class="n">triggers</span><span class="o">=</span><span class="n">triggers</span><span class="p">,</span>
        <span class="c1"># It is important to include all blocks that are instantiated here in the blocks</span>
        <span class="c1"># field and make sure they follow the order of the flow. For example, if machine</span>
        <span class="c1"># classification depends on the output of case collation, then case_collation must</span>
        <span class="c1"># come before machine_classification in this blocks array</span>
        <span class="n">blocks</span><span class="o">=</span><span class="p">[</span>
            <span class="n">submission_bootstrap</span><span class="p">,</span>
            <span class="n">case_collation</span><span class="p">,</span>
            <span class="n">machine_classification</span><span class="p">,</span>
            <span class="n">manual_classification</span><span class="p">,</span>
            <span class="n">machine_identification</span><span class="p">,</span>
            <span class="n">manual_identification</span><span class="p">,</span>
            <span class="n">machine_transcription</span><span class="p">,</span>
            <span class="n">manual_transcription</span><span class="p">,</span>
            <span class="n">flexible_extraction</span><span class="p">,</span>
            <span class="n">custom_code</span><span class="p">,</span>
            <span class="n">submission_complete</span><span class="p">,</span>
            <span class="n">outputs</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">get_idp_wf_inputs</span><span class="p">(</span><span class="n">idp_wf_config</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Intelligent Document Processing with Custom Code Block Flow Example (V32)&#39;</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission_complete</span><span class="o">.</span><span class="n">output</span><span class="p">()},</span>
    <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">export_flow</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="n">entry_point_flow</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="invoice-validation">
<h2>Invoice Validation<a class="headerlink" href="#invoice-validation" title="Permalink to this headline"></a></h2>
<p>This example validates invoice line items and the total invoice amount and routes to a Flexible Extraction block for discrepancies.</p>
<p><a class="reference download internal" download="" href="../_downloads/d13c9b2db3581c7c1719101952ebaf9f/invoice_validation_v32.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">invoice_validation.zip</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">UUID</span>

<span class="kn">from</span> <span class="nn">flows_sdk.blocks</span> <span class="kn">import</span> <span class="n">CodeBlock</span>
<span class="kn">from</span> <span class="nn">flows_sdk.flows</span> <span class="kn">import</span> <span class="n">Flow</span><span class="p">,</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">flows_sdk.implementations.idp_v32.idp_blocks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CaseCollationBlock</span><span class="p">,</span>
    <span class="n">FlexibleExtractionBlock</span><span class="p">,</span>
    <span class="n">IDPOutputsBlock</span><span class="p">,</span>
    <span class="n">MachineClassificationBlock</span><span class="p">,</span>
    <span class="n">MachineIdentificationBlock</span><span class="p">,</span>
    <span class="n">MachineTranscriptionBlock</span><span class="p">,</span>
    <span class="n">ManualClassificationBlock</span><span class="p">,</span>
    <span class="n">ManualIdentificationBlock</span><span class="p">,</span>
    <span class="n">ManualTranscriptionBlock</span><span class="p">,</span>
    <span class="n">SubmissionBootstrapBlock</span><span class="p">,</span>
    <span class="n">SubmissionCompleteBlock</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">flows_sdk.implementations.idp_v32.idp_values</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IDPManifest</span><span class="p">,</span>
    <span class="n">IDPTriggers</span><span class="p">,</span>
    <span class="n">get_idp_wf_config</span><span class="p">,</span>
    <span class="n">get_idp_wf_inputs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">flows_sdk.package_utils</span> <span class="kn">import</span> <span class="n">export_flow</span>
<span class="kn">from</span> <span class="nn">flows_sdk.utils</span> <span class="kn">import</span> <span class="n">workflow_input</span>


<span class="k">class</span> <span class="nc">CustomSettings</span><span class="p">:</span>
    <span class="n">SkipFlexibleExtraction</span> <span class="o">=</span> <span class="s1">&#39;Skip Flexible Extraction For Validation Discrepancies&#39;</span>
    <span class="n">IgnoreLineItemTranscription</span> <span class="o">=</span> <span class="s1">&#39;Ignore Table Fields Not Transcribed&#39;</span>


<span class="n">LINE_ITEM_VALIDATION_PARAMETERS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">CustomSettings</span><span class="o">.</span><span class="n">SkipFlexibleExtraction</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">CustomSettings</span><span class="o">.</span><span class="n">SkipFlexibleExtraction</span><span class="p">,</span>
        <span class="n">ui</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Check this box to skip Flexible Extraction when line item validation and &#39;</span>
                    <span class="s1">&#39;total amount discrepancies occur. Useful when downstream processes address any &#39;</span>
                    <span class="s1">&#39;discrepancies&#39;</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Parameter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">CustomSettings</span><span class="o">.</span><span class="n">IgnoreLineItemTranscription</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">CustomSettings</span><span class="o">.</span><span class="n">IgnoreLineItemTranscription</span><span class="p">,</span>
        <span class="n">ui</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Check this box to prevent columns_not_transcribed messages in the output&#39;</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">entry_point_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">idp_workflow</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">idp_workflow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">:</span>
    <span class="n">idp_wf_config</span> <span class="o">=</span> <span class="n">get_idp_wf_config</span><span class="p">()</span>

    <span class="c1"># The idp flow basically processes, modifies and propagates the submission object from</span>
    <span class="c1"># block to block</span>
    <span class="c1"># Each block&#39;s processing result is usually included in the submission object</span>

    <span class="c1"># Submission bootstrap block initializes the submission object and prepares external images</span>
    <span class="c1"># or other submission data if needed</span>
    <span class="n">submission_bootstrap</span> <span class="o">=</span> <span class="n">SubmissionBootstrapBlock</span><span class="p">(</span><span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;submission_bootstrap&#39;</span><span class="p">)</span>

    <span class="c1"># Case collation block groups files, documents and pages (from the submission) into cases</span>
    <span class="c1"># In this example, case collation block receives the submission object and the cases</span>
    <span class="c1"># information from submission bootstrap block</span>
    <span class="n">case_collation</span> <span class="o">=</span> <span class="n">CaseCollationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_collation&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.submission&#39;</span><span class="p">),</span>
        <span class="n">cases</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params.cases&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Machine classification block automatically matches documents to structured, semi-structured</span>
    <span class="c1"># or additional layouts</span>
    <span class="c1"># In this example, machine classification block receives the submission object from</span>
    <span class="c1"># case collation block</span>
    <span class="n">machine_classification</span> <span class="o">=</span> <span class="n">MachineClassificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_classification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">case_collation</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Manual classification block allows keyers to manually match submissions to their layouts.</span>
    <span class="c1"># Keyers may perform manual classification if machine classification cannot automatically</span>
    <span class="c1"># match a submission to a layout with high confidence</span>
    <span class="c1"># In this example, manual classification block receives the submission object from machine</span>
    <span class="c1"># classification block</span>
    <span class="n">manual_classification</span> <span class="o">=</span> <span class="n">ManualClassificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_classification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">machine_classification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Machine identification automatically identify fields and tables in the submission</span>
    <span class="c1"># In this example, machine identification block receives the submission object from manual</span>
    <span class="c1"># classification</span>
    <span class="n">machine_identification</span> <span class="o">=</span> <span class="n">MachineIdentificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_identification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">manual_classification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Manual identification allows keyers to complete field identification or table identification</span>
    <span class="c1"># tasks, where they draw bounding boxes around the contents of certain fields, table columns</span>
    <span class="c1"># or table rows. This identification process ensures that the system will be able to</span>
    <span class="c1"># transcribe the correct content in the upcoming transcription process</span>
    <span class="c1"># In this example, manual identification block receives the submission object from machine</span>
    <span class="c1"># identification</span>
    <span class="n">manual_identification</span> <span class="o">=</span> <span class="n">ManualIdentificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_identification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">machine_identification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Machine transcription automatically transcribes the content of your submission</span>
    <span class="c1"># In this example, machine identification block receives the submission object from manual</span>
    <span class="c1"># identification</span>
    <span class="n">machine_transcription</span> <span class="o">=</span> <span class="n">MachineTranscriptionBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_transcription&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">manual_identification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Manual transcription lets your keyers manually enter the text found in fields or tables</span>
    <span class="c1"># that could not be automatically transcribed</span>
    <span class="c1"># In this example, manual transcription block receives the submission object from machine</span>
    <span class="c1"># transcription block</span>
    <span class="n">manual_transcription</span> <span class="o">=</span> <span class="n">ManualTranscriptionBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_transcription&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">machine_transcription</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_perform_line_item_validations</span><span class="p">(</span>
            <span class="n">submission</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
            <span class="n">api_params_ref</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
            <span class="n">wf_param_skip_fleex</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
            <span class="n">wf_param_ignore_transcribed</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Pseudo Code:</span>
<span class="sd">                Iterate submission documents:</span>
<span class="sd">                    Initialize invoice total, if total_invoice_amount field transcribed</span>
<span class="sd">                    Convert document table to row format from submission columnar format</span>
<span class="sd">                    Iterate data rows:</span>
<span class="sd">                        Determine transcription results for each row</span>
<span class="sd">                        Determine calculations for each row from transcription results</span>
<span class="sd">                        Store transcription &amp; calculation results in row_results object</span>
<span class="sd">                        For row columns both transcribed and calculated perform validations</span>
<span class="sd">                            Mark for Flexible Extraction row columns with differences</span>
<span class="sd">                            Mark for IDP Sync columns calculated but not transcribed (future)</span>
<span class="sd">                    Mark for Flexible Extraction if line item calculations differ from invoice total</span>
<span class="sd">            Dictionary objects:</span>
<span class="sd">                row_results: Contains information about transcription/calculation for each row</span>
<span class="sd">                document_validation: Contains all row results for the document</span>
<span class="sd">                line_item_validation: Contains the results for all documents in the submission</span>
<span class="sd">            &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

        <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="kn">import</span> <span class="nn">logging</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table_line_item_validation: _perform_line_item_validations(): entered&#39;</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">locale</span>

        <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s1">&#39;en_US.UTF-8&#39;</span><span class="p">)</span>

        <span class="n">TRANSCRIPTION_SOURCE_CUSTOM</span> <span class="o">=</span> <span class="s1">&#39;custom&#39;</span>

        <span class="k">def</span> <span class="nf">_my_get_float</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">currency_symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">localeconv</span><span class="p">()[</span><span class="s1">&#39;currency_symbol&#39;</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                    <span class="k">return</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">currency_symbol</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not convert value=&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&quot; to float&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>

        <span class="k">def</span> <span class="nf">_format_column</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lcol</span> <span class="o">=</span> <span class="n">column_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;quantity&#39;</span> <span class="ow">in</span> <span class="n">lcol</span> <span class="ow">or</span> <span class="s1">&#39;unit_price&#39;</span> <span class="ow">in</span> <span class="n">lcol</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;total_price&#39;</span> <span class="ow">in</span> <span class="n">lcol</span> <span class="ow">or</span> <span class="s1">&#39;amount&#39;</span> <span class="ow">in</span> <span class="n">lcol</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_my_get_currency</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;_format_column(): error occurred for float value=</span><span class="si">{}</span><span class="s1">, &#39;</span>
                    <span class="s1">&#39;column_name=</span><span class="si">{}</span><span class="s1">, error=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">value</span><span class="p">,</span>
                    <span class="n">column_name</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;0.0&#39;</span>

        <span class="k">def</span> <span class="nf">_my_get_currency</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">locale</span><span class="o">.</span><span class="n">currency</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">grouping</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_can_calculate</span><span class="p">(</span><span class="n">line_item_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">calc_columns</span><span class="p">:</span> <span class="nb">set</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Shortcut function for determining whether a line item has enough information</span>
<span class="sd">                to perform a calculation</span>
<span class="sd">                &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calc_columns</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">line_item_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">calc_col</span> <span class="ow">in</span> <span class="n">calc_columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line_item_data</span><span class="p">[</span><span class="n">calc_col</span><span class="p">][</span><span class="s1">&#39;has_value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="nf">_table_columns_to_row_data</span><span class="p">(</span><span class="n">document</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="sd">&quot;&quot;&quot;Converts document table cells to a different format&quot;&quot;&quot;</span>
            <span class="n">row_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CALC_LINE_ITEM_ALL_COLS</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cells&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">row_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;page_number&#39;</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;row_number&#39;</span><span class="p">])</span>
                    <span class="n">row_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">row_key</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;output_name&#39;</span><span class="p">]:</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transcription_normalized&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)}</span>
                    <span class="p">)</span>

            <span class="k">return</span> <span class="n">row_data</span>

        <span class="k">def</span> <span class="nf">_get_row_results_transcribed</span><span class="p">(</span><span class="n">row_column</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Returns a dict for line item columns (Quantity, Unit Price, Total Price) showing</span>
<span class="sd">                results of the transcription:</span>
<span class="sd">                    * was the field transcribed</span>
<span class="sd">                    * does the transcribed field contain a value (i.e. not empty string)</span>
<span class="sd">                    * the normalized value</span>
<span class="sd">                    * a float representation of the normalized value</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">ret</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">CALC_LINE_ITEM_ALL_COLS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row_column</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">transcribed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">has_value</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">row_column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col_name</span><span class="p">):</span>
                    <span class="n">transcribed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">has_value</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">normalized</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">row_column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">col_name</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;transcription_normalized&#39;</span><span class="p">:</span> <span class="n">normalized</span><span class="p">}})</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">normalized_float</span> <span class="o">=</span> <span class="n">_my_get_float</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c1"># has_value = False</span>
                        <span class="n">normalized_float</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;Transcription error for </span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="p">)</span>

                    <span class="n">ret</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;float_value&#39;</span><span class="p">:</span> <span class="n">normalized_float</span><span class="p">})</span>

                <span class="n">ret</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;transcribed&#39;</span><span class="p">:</span> <span class="n">transcribed</span><span class="p">,</span> <span class="s1">&#39;has_value&#39;</span><span class="p">:</span> <span class="n">has_value</span><span class="p">})</span>

            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">def</span> <span class="nf">_get_row_results_calculated</span><span class="p">(</span><span class="n">line_item_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Returns a dict for calculations on a line item. Only columns that can be calculated</span>
<span class="sd">                are included in the return dict. This serves as an indicator that we can validate</span>
<span class="sd">                a line item. IOW, if a column is not present in the row results calculated then we</span>
<span class="sd">                can&#39;t validate the line item</span>
<span class="sd">                &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">_can_calculate</span><span class="p">(</span><span class="n">line_item_data</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;quantity&#39;</span><span class="p">}):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">_my_get_float</span><span class="p">(</span><span class="n">line_item_data</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;transcription_normalized&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">row_results</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions_calculated&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Transcription error for quantity: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="n">_can_calculate</span><span class="p">(</span><span class="n">line_item_data</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;unit_price&#39;</span><span class="p">}):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">_my_get_float</span><span class="p">(</span><span class="n">line_item_data</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">][</span><span class="s1">&#39;transcription_normalized&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">row_results</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions_calculated&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Transcription error for unit_price: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="n">_can_calculate</span><span class="p">(</span><span class="n">line_item_data</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;total_price&#39;</span><span class="p">}):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">_my_get_float</span><span class="p">(</span><span class="n">line_item_data</span><span class="p">[</span><span class="s1">&#39;total_price&#39;</span><span class="p">][</span><span class="s1">&#39;transcription_normalized&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">row_results</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions_calculated&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Transcription error for total_price: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">_can_calculate</span><span class="p">(</span><span class="n">line_item_data</span><span class="p">,</span> <span class="n">CALC_TOTAL_PRICE_COLS</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;total_price&#39;</span><span class="p">:</span> <span class="n">q</span> <span class="o">*</span> <span class="n">u</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">_can_calculate</span><span class="p">(</span><span class="n">line_item_data</span><span class="p">,</span> <span class="n">CALC_QUANTITY_COLS</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">t</span> <span class="o">/</span> <span class="n">u</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">_can_calculate</span><span class="p">(</span><span class="n">line_item_data</span><span class="p">,</span> <span class="n">CALC_UNIT_PRICE_COLS</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">q</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;unit_price&#39;</span><span class="p">:</span> <span class="n">t</span> <span class="o">/</span> <span class="n">q</span><span class="p">})</span>

            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">def</span> <span class="nf">_require_idp_sync</span><span class="p">(</span>
                <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">row_key</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">transcription_normalized</span><span class="p">:</span> <span class="nb">str</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                TODO: When/if we merge line item columns that were not transcribed but could be</span>
<span class="sd">                    calculated we would then perform IDP sync. Note when performing IDP sync for</span>
<span class="sd">                    a table that all rows and columns must be supplied to the IDP sync process.</span>
<span class="sd">                &quot;&quot;&quot;</span>
            <span class="n">line_item_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;idp_sync&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="n">document_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;idp_sync&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

            <span class="n">sync_cell</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;column_name&#39;</span><span class="p">:</span> <span class="n">column_name</span><span class="p">,</span>
                <span class="s1">&#39;document_id&#39;</span><span class="p">:</span> <span class="n">row_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;page_number&#39;</span><span class="p">:</span> <span class="n">row_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;row_number&#39;</span><span class="p">:</span> <span class="n">row_key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s1">&#39;transcription_normalized&#39;</span><span class="p">:</span> <span class="n">transcription_normalized</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">document_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;sync_columns&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sync_cell</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_require_flexible_extraction_for_cell</span><span class="p">(</span>
                <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">row_key</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Marks a table cell for Flexible Extraction. An exception string is appended to</span>
<span class="sd">                 the submission, document, and field/table cell.</span>
<span class="sd">                &quot;&quot;&quot;</span>

            <span class="n">line_item_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
            <span class="n">document_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">wf_param_skip_fleex</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">line_item_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;flexible_extraction&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
                <span class="n">document_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;flexible_extraction&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">column_name</span> <span class="ow">and</span> <span class="n">row_key</span><span class="p">:</span>
                <span class="n">doc_table_col</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">doc_table_cell</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="s1">&#39;output_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">column_name</span><span class="p">:</span>
                        <span class="n">doc_table_col</span> <span class="o">=</span> <span class="n">column</span>
                        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cells&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;page_number&#39;</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;row_number&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span>
                                    <span class="n">row_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">row_key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                            <span class="p">):</span>
                                <span class="n">doc_table_cell</span> <span class="o">=</span> <span class="n">cell</span>
                                <span class="k">break</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="n">doc_table_col</span> <span class="ow">and</span> <span class="n">doc_table_cell</span><span class="p">:</span>
                    <span class="n">document_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;field_name&#39;</span><span class="p">:</span> <span class="n">doc_table_col</span><span class="p">[</span><span class="s1">&#39;field_name&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;output_name&#39;</span><span class="p">:</span> <span class="n">column_name</span><span class="p">,</span>
                            <span class="s1">&#39;page_number&#39;</span><span class="p">:</span> <span class="n">row_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="s1">&#39;row_number&#39;</span><span class="p">:</span> <span class="n">row_key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                            <span class="s1">&#39;flexible_extraction&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s1">&#39;exceptions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">message</span><span class="p">],</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">wf_param_skip_fleex</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">doc_table_cell</span><span class="p">[</span><span class="s1">&#39;process_flexible_extraction_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;FORCE&#39;</span>
                        <span class="n">doc_table_cell</span><span class="p">[</span><span class="s1">&#39;needs_flexible_extraction_review&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">doc_table_cell</span><span class="p">[</span><span class="s1">&#39;transcription_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRANSCRIPTION_SOURCE_CUSTOM</span>
                    <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
                        <span class="n">doc_table_cell</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                        <span class="n">document</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                        <span class="n">submission</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;page_</span><span class="si">{</span><span class="n">row_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">_row_</span><span class="si">{</span><span class="n">row_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">_require_flexible_extraction_reason</span><span class="p">(</span><span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Marks the document for Flexible Extraction. The reason is added as an exception</span>
<span class="sd">                &quot;&quot;&quot;</span>

            <span class="n">line_item_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
            <span class="n">document_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

            <span class="n">line_item_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;flexible_extraction&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="n">document_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;flexible_extraction&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">reason</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reason</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">document_validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reasons&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">document_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;reasons&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
                    <span class="n">document</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
                    <span class="n">submission</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>

            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">_require_flexible_extraction_for_field</span><span class="p">(</span>
                <span class="n">field_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Marks the document_field for Flexible Extraction. An exception string is appended</span>
<span class="sd">                 to the submission, document, and field/table cell.</span>
<span class="sd">                &quot;&quot;&quot;</span>
            <span class="n">line_item_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
            <span class="n">document_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

            <span class="n">line_item_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;flexible_extraction&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="n">document_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;flexible_extraction&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">reason</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reason</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">document_validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reasons&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">document_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;reasons&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
                    <span class="n">document</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
                    <span class="n">submission</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;document id=</span><span class="si">{</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">; </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">message</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">document_validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">document_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="n">document</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="n">submission</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;document id=</span><span class="si">{</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">; </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                    <span class="n">line_item_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">field_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;fields&#39;</span> <span class="ow">in</span> <span class="n">document_validation</span><span class="p">:</span>
                    <span class="n">validation_field</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">field</span>
                        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">document_validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="p">[])</span>
                        <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;field_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">field_id</span>
                    <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">validation_field</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">reason</span> <span class="ow">and</span> <span class="n">reason</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">validation_field</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reasons&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                            <span class="n">validation_field</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;reasons&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">message</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">validation_field</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                            <span class="n">validation_field</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">validation_field</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
                        <span class="k">return</span>

                <span class="n">doc_field</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;document_fields&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">field_id</span>
                <span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">doc_field</span><span class="p">:</span>
                    <span class="n">document_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;field_id&#39;</span><span class="p">:</span> <span class="n">field_id</span><span class="p">,</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">doc_field</span><span class="p">[</span><span class="s1">&#39;field_name&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;output_name&#39;</span><span class="p">:</span> <span class="n">doc_field</span><span class="p">[</span><span class="s1">&#39;output_name&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;flexible_extraction&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s1">&#39;reasons&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">reason</span><span class="p">],</span>
                            <span class="s1">&#39;exceptions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">message</span><span class="p">],</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">wf_param_skip_fleex</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">doc_field</span><span class="p">[</span><span class="s1">&#39;process_flexible_extraction_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;FORCE&#39;</span>
                        <span class="n">doc_field</span><span class="p">[</span><span class="s1">&#39;needs_flexible_extraction_review&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">doc_field</span><span class="p">[</span><span class="s1">&#39;transcription_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRANSCRIPTION_SOURCE_CUSTOM</span>

            <span class="k">return</span>

        <span class="n">CALC_LINE_ITEM_ALL_COLS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;total_price&#39;</span><span class="p">}</span>

        <span class="n">CALC_TOTAL_PRICE_COLS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;unit_price&#39;</span><span class="p">}</span>
        <span class="n">CALC_QUANTITY_COLS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;total_price&#39;</span><span class="p">}</span>
        <span class="n">CALC_UNIT_PRICE_COLS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;total_price&#39;</span><span class="p">}</span>

        <span class="n">line_item_validation</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;documents&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">document_validation</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;flexible_extraction&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

            <span class="n">invoice</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;running_total&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>

            <span class="c1"># Initialize invoice total, if total_invoice_amount field transcribed</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;document_fields&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;total_invoice_amount&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table_line_item_validation: found total_invoice_amount&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transcription_normalized&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">total_invoice_amount</span> <span class="o">=</span> <span class="n">_my_get_float</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;transcription_normalized&#39;</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">total_invoice_amount</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Transcription error for total_invoice_amount: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                            <span class="n">_require_flexible_extraction_for_field</span><span class="p">(</span>
                                <span class="n">field</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="s1">&#39;total_invoice_amount_transcription_error&#39;</span><span class="p">,</span> <span class="n">msg</span>
                            <span class="p">)</span>

                        <span class="n">invoice</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;total_invoice_amount&#39;</span><span class="p">:</span> <span class="n">total_invoice_amount</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">field</span><span class="p">}</span>
                        <span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;table&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">document</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">line_item_validation</span><span class="p">:</span>
                <span class="c1"># initialize line_item_validation first time we encounter a document</span>
                <span class="c1"># assume document is valid and fleex is not required</span>
                <span class="n">line_item_validation</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;flexible_extraction&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

            <span class="n">line_item_columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">column</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="s1">&#39;output_name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">CALC_LINE_ITEM_ALL_COLS</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">line_item_columns</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No line item validation columns found in table&#39;</span><span class="p">)</span>
                <span class="n">document</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;No line item validation columns found in table: </span><span class="si">{</span><span class="n">CALC_LINE_ITEM_ALL_COLS</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="n">document_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;No line item validation columns found in table: </span><span class="si">{</span><span class="n">CALC_LINE_ITEM_ALL_COLS</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="n">line_item_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;No line item validation columns found in table: document id=</span><span class="si">{</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Convert document table to row format from submission columnar format</span>
            <span class="c1">#</span>
            <span class="c1">#   row_key is Tuple(document[&#39;id&#39;], cell[&#39;page_number&#39;], cell[&#39;row_number&#39;])</span>
            <span class="c1">#       {</span>
            <span class="c1">#           output_name: transcription_normalized</span>
            <span class="c1">#       }</span>
            <span class="c1">#</span>
            <span class="n">row_data</span> <span class="o">=</span> <span class="n">_table_columns_to_row_data</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">row_data</span><span class="p">:</span>
                <span class="n">document</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;No table row data available for validations&#39;</span>
                <span class="p">)</span>
                <span class="n">document_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;No table row data available for validations&#39;</span>
                <span class="p">)</span>
                <span class="n">line_item_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;No table row data available for validations for document id &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">row_key</span><span class="p">,</span> <span class="n">row_data_info</span> <span class="ow">in</span> <span class="n">row_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">row_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;all_transcribed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;columns_transcribed&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
                    <span class="s1">&#39;columns_not_transcribed&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
                    <span class="s1">&#39;exceptions_transcribed&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;all_calculated&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;columns_calculated&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
                    <span class="s1">&#39;columns_not_calculated&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
                    <span class="s1">&#39;exceptions_calculated&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="p">}</span>

                <span class="c1"># Determine transcription results for each row</span>
                <span class="n">line_item_transcribed</span> <span class="o">=</span> <span class="n">_get_row_results_transcribed</span><span class="p">(</span><span class="n">row_data_info</span><span class="p">)</span>

                <span class="c1"># a set containing only columns that were transcribed</span>
                <span class="n">columns_transcribed</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">col_name</span>
                    <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_info</span> <span class="ow">in</span> <span class="n">line_item_transcribed</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">col_info</span><span class="p">[</span><span class="s1">&#39;transcribed&#39;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="n">columns_not_transcribed</span> <span class="o">=</span> <span class="n">CALC_LINE_ITEM_ALL_COLS</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">columns_transcribed</span><span class="p">)</span>

                <span class="n">transcription_exceptions</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="sa">f</span><span class="s1">&#39;id_</span><span class="si">{</span><span class="n">row_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_page_</span><span class="si">{</span><span class="n">row_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">_row_</span><span class="si">{</span><span class="n">row_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">line_item_transcribed</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="p">]</span>

                <span class="c1"># the CustomSetting doesn&#39;t apply to errors for fields</span>
                <span class="c1"># that have been transcribed</span>
                <span class="c1">#</span>
                <span class="c1"># the CustomSetting prevents errors when a line item field was not found</span>
                <span class="k">if</span> <span class="n">transcription_exceptions</span><span class="p">:</span>
                    <span class="n">document_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">transcription_exceptions</span>
                    <span class="p">)</span>
                    <span class="n">line_item_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">transcription_exceptions</span>
                    <span class="p">)</span>

                <span class="c1"># add the line item amount to the running total</span>
                <span class="k">if</span> <span class="s1">&#39;total_price&#39;</span> <span class="ow">in</span> <span class="n">line_item_transcribed</span><span class="p">:</span>
                    <span class="n">total_price_exceptions</span> <span class="o">=</span> <span class="n">line_item_transcribed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_price&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_price_exceptions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">_require_flexible_extraction_for_cell</span><span class="p">(</span>
                            <span class="s1">&#39;total_price&#39;</span><span class="p">,</span> <span class="n">row_key</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">total_price_exceptions</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">line_item_transcribed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_price&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_value&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="n">invoice</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s1">&#39;running_total&#39;</span><span class="p">:</span> <span class="n">invoice</span><span class="p">[</span><span class="s1">&#39;running_total&#39;</span><span class="p">]</span>
                                                 <span class="o">+</span> <span class="n">line_item_transcribed</span><span class="p">[</span><span class="s1">&#39;total_price&#39;</span><span class="p">][</span>
                                                     <span class="s1">&#39;float_value&#39;</span><span class="p">]</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

                <span class="c1"># Determine calculations for each row from transcription results</span>
                <span class="c1"># Calculate line item columns based on transcription results</span>
                <span class="c1">#</span>
                <span class="c1"># a column is only present in line_item_calculated if it can be calculated</span>
                <span class="c1">#</span>
                <span class="n">line_item_calculated</span> <span class="o">=</span> <span class="n">_get_row_results_calculated</span><span class="p">(</span><span class="n">line_item_transcribed</span><span class="p">)</span>

                <span class="n">columns_calculated</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">line_item_calculated</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">columns_not_calculated</span> <span class="o">=</span> <span class="n">CALC_LINE_ITEM_ALL_COLS</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">columns_calculated</span><span class="p">)</span>

                <span class="c1"># Store transcription &amp; calculation results in row_results object</span>
                <span class="c1">#</span>
                <span class="c1"># sets are converted to lists since sets cannot be serialized which results in a</span>
                <span class="c1"># TypeError during flow execution</span>
                <span class="c1">#</span>
                <span class="n">row_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;all_transcribed&#39;</span><span class="p">:</span> <span class="n">columns_transcribed</span> <span class="o">==</span> <span class="n">CALC_LINE_ITEM_ALL_COLS</span><span class="p">,</span>
                        <span class="s1">&#39;columns_transcribed&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns_transcribed</span><span class="p">),</span>
                        <span class="s1">&#39;columns_not_transcribed&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns_not_transcribed</span><span class="p">),</span>
                        <span class="s1">&#39;exceptions_transcribed&#39;</span><span class="p">:</span> <span class="n">transcription_exceptions</span><span class="p">,</span>
                        <span class="s1">&#39;all_calculated&#39;</span><span class="p">:</span> <span class="n">line_item_calculated</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">CALC_LINE_ITEM_ALL_COLS</span><span class="p">,</span>
                        <span class="s1">&#39;columns_calculated&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns_calculated</span><span class="p">),</span>
                        <span class="s1">&#39;columns_not_calculated&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns_not_calculated</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>

                <span class="c1"># For row columns both transcribed and calculated perform validations</span>
                <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">columns_transcribed</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">columns_calculated</span><span class="p">):</span>
                    <span class="n">transcribed_value</span> <span class="o">=</span> <span class="n">line_item_transcribed</span><span class="p">[</span><span class="n">col_name</span><span class="p">][</span><span class="s1">&#39;float_value&#39;</span><span class="p">]</span>
                    <span class="n">calculated_value</span> <span class="o">=</span> <span class="n">line_item_calculated</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
                    <span class="n">difference</span> <span class="o">=</span> <span class="n">transcribed_value</span> <span class="o">-</span> <span class="n">calculated_value</span>
                    <span class="n">row_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="n">col_name</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;transcribed_value&#39;</span><span class="p">:</span> <span class="n">transcribed_value</span><span class="p">,</span>
                                <span class="s1">&#39;calculated_value&#39;</span><span class="p">:</span> <span class="n">_format_column</span><span class="p">(</span><span class="n">calculated_value</span><span class="p">,</span> <span class="n">col_name</span><span class="p">),</span>
                                <span class="s1">&#39;difference&#39;</span><span class="p">:</span> <span class="n">_format_column</span><span class="p">(</span><span class="n">difference</span><span class="p">,</span> <span class="n">col_name</span><span class="p">),</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">calculated_value</span><span class="p">,</span> <span class="n">transcribed_value</span><span class="p">):</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s1">: value_difference; transcribed=&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_format_column</span><span class="p">(</span><span class="n">transcribed_value</span><span class="p">,</span> <span class="n">col_name</span><span class="p">)</span><span class="si">}</span><span class="s1">, &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;calculated=</span><span class="si">{</span><span class="n">_format_column</span><span class="p">(</span><span class="n">calculated_value</span><span class="p">,</span> <span class="n">col_name</span><span class="p">)</span><span class="si">}</span><span class="s1">, &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;difference=</span><span class="si">{</span><span class="n">_format_column</span><span class="p">(</span><span class="n">difference</span><span class="p">,</span> <span class="n">col_name</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="p">)</span>

                        <span class="n">_require_flexible_extraction_for_cell</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">row_key</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">wf_param_ignore_transcribed</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="c1">#</span>
                    <span class="c1"># Mark for IDP Sync columns calculated but not transcribed</span>
                    <span class="c1">#</span>
                    <span class="c1"># For example, unit price &amp; total price were transcribed but quantity</span>
                    <span class="c1"># was not. The quantity can be calculated and the added to the row</span>
                    <span class="c1">#</span>
                    <span class="c1"># TODO: if we&#39;ve calculated columns that were not transcribed we can</span>
                    <span class="c1">#   add them through IDP sync. If the invoice total validation fails</span>
                    <span class="c1">#   then also send the added row cell to flexible extraction</span>
                    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">columns_calculated</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">columns_transcribed</span><span class="p">):</span>
                        <span class="c1"># this column was calculated but not transcribed - add it via IDP sync later</span>
                        <span class="n">_require_idp_sync</span><span class="p">(</span>
                            <span class="n">col_name</span><span class="p">,</span>
                            <span class="n">row_key</span><span class="p">,</span>
                            <span class="n">_format_column</span><span class="p">(</span><span class="n">line_item_calculated</span><span class="p">[</span><span class="n">col_name</span><span class="p">],</span> <span class="n">col_name</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">row_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;idp_sync_cols&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">row_results</span><span class="p">[</span><span class="s1">&#39;all_transcribed&#39;</span><span class="p">]:</span>
                        <span class="n">_require_flexible_extraction_reason</span><span class="p">(</span><span class="s1">&#39;columns_not_transcribed&#39;</span><span class="p">)</span>

            <span class="c1"># Mark for Flexible Extraction if line item calculations differ from invoice total</span>
            <span class="k">if</span> <span class="s1">&#39;total_invoice_amount&#39;</span> <span class="ow">in</span> <span class="n">invoice</span><span class="p">:</span>
                <span class="n">document_validation</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;total_amount&#39;</span><span class="p">:</span> <span class="n">_format_column</span><span class="p">(</span><span class="n">invoice</span><span class="p">[</span><span class="s1">&#39;total_invoice_amount&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;line_item_total_amount&#39;</span><span class="p">:</span> <span class="n">_format_column</span><span class="p">(</span><span class="n">invoice</span><span class="p">[</span><span class="s1">&#39;running_total&#39;</span><span class="p">]),</span>
                    <span class="p">}</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">invoice</span><span class="p">[</span><span class="s1">&#39;running_total&#39;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">):</span>

                    <span class="n">_require_flexible_extraction_reason</span><span class="p">(</span><span class="s1">&#39;could_not_calculate_total_invoice_amount&#39;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">invoice</span><span class="p">[</span><span class="s1">&#39;total_invoice_amount&#39;</span><span class="p">],</span> <span class="n">invoice</span><span class="p">[</span><span class="s1">&#39;running_total&#39;</span><span class="p">]):</span>

                    <span class="n">document_validation</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;total_difference&#39;</span><span class="p">:</span> <span class="n">_format_column</span><span class="p">(</span>
                                <span class="n">invoice</span><span class="p">[</span><span class="s1">&#39;total_invoice_amount&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">invoice</span><span class="p">[</span><span class="s1">&#39;running_total&#39;</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s1">&#39;Line item total does not equal invoice total: &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">invoice</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">][</span><span class="s2">&quot;field_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">invoice</span><span class="p">[</span><span class="s2">&quot;total_invoice_amount&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span>
                        <span class="s1">&#39;(Transcribed); &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Line Item Total=</span><span class="si">{</span><span class="n">_format_column</span><span class="p">(</span><span class="n">invoice</span><span class="p">[</span><span class="s2">&quot;running_total&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> &#39;</span>
                        <span class="s1">&#39;(Calculated); &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Difference=</span><span class="si">{</span><span class="n">document_validation</span><span class="p">[</span><span class="s2">&quot;total_difference&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">; &#39;</span>
                    <span class="p">)</span>

                    <span class="n">_require_flexible_extraction_for_field</span><span class="p">(</span>
                        <span class="n">field_id</span><span class="o">=</span><span class="n">invoice</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                        <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;total_invoice_amount_difference&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">document_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
                <span class="n">document_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;Could not locate field output_name=total_invoice_amount&#39;</span>
                <span class="p">)</span>
                <span class="n">line_item_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
                <span class="n">line_item_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;Could not locate field output_name=total_invoice_amount &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;for document id: </span><span class="si">{</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

            <span class="c1"># set to fleex when it&#39;s required and the skip param is false</span>
            <span class="k">if</span> <span class="p">(</span>
                    <span class="n">document_validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flexible_extraction&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">wf_param_skip_fleex</span> <span class="ow">is</span> <span class="kc">False</span>
            <span class="p">):</span>
                <span class="n">document</span><span class="p">[</span><span class="s1">&#39;needs_flexible_extraction_review&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">line_item_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;doc_</span><span class="si">{</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">document_validation</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">document_validation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_valid&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">line_item_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

        <span class="k">if</span> <span class="s1">&#39;is_valid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_item_validation</span><span class="p">:</span>
            <span class="c1"># no documents were processed when is_valid is not in line_item_validation</span>
            <span class="n">line_item_validation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
            <span class="n">line_item_validation</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;No validations occurred due &#39;</span> <span class="s1">&#39;to incomplete submission data&#39;</span>
            <span class="p">)</span>

        <span class="n">submission</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;line_item_validation&#39;</span><span class="p">:</span> <span class="n">line_item_validation</span><span class="p">})</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table_line_item_validation: _perform_line_item_validations(): returned&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="p">,</span> <span class="s1">&#39;line_item_validation&#39;</span><span class="p">:</span> <span class="n">line_item_validation</span><span class="p">}</span>

    <span class="n">line_item_validation</span> <span class="o">=</span> <span class="n">CodeBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;perform_validate_line_items&#39;</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="n">_perform_line_item_validations</span><span class="p">,</span>
        <span class="n">code_input</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">manual_transcription</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
            <span class="s1">&#39;api_params_ref&#39;</span><span class="p">:</span> <span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
            <span class="s1">&#39;wf_param_skip_fleex&#39;</span><span class="p">:</span> <span class="n">workflow_input</span><span class="p">(</span><span class="n">CustomSettings</span><span class="o">.</span><span class="n">SkipFlexibleExtraction</span><span class="p">),</span>
            <span class="s1">&#39;wf_param_ignore_transcribed&#39;</span><span class="p">:</span> <span class="n">workflow_input</span><span class="p">(</span>
                <span class="n">CustomSettings</span><span class="o">.</span><span class="n">IgnoreLineItemTranscription</span>
            <span class="p">)</span>
        <span class="p">},</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Validate Line Items&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Validates the Invoice&#39;&#39;s Line Items&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Flexible extraction manually transcribes fields marked for review</span>
    <span class="c1"># In this example, flexible extraction block receives the submission object from manual</span>
    <span class="c1"># transcription block</span>
    <span class="n">flexible_extraction</span> <span class="o">=</span> <span class="n">FlexibleExtractionBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;flexible_extraction&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">line_item_validation</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_submission</span><span class="p">(</span><span class="n">submission</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">inspect</span>

        <span class="n">submission_id_ref</span> <span class="o">=</span> <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="n">sdm_get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;api/v5/submissions/</span><span class="si">{</span><span class="n">submission_id_ref</span><span class="si">}</span><span class="s1">?flat=False&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="n">load_submission</span> <span class="o">=</span> <span class="n">CodeBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;load_submission&#39;</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="n">_load_submission</span><span class="p">,</span>
        <span class="n">code_input</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">flexible_extraction</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">)},</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Load Submission&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Returns Submission in API v5 Format&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mark_as_complete</span><span class="p">(</span><span class="n">submission</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">line_item_validation</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line_item_validation</span><span class="p">:</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;line_item_validation&#39;</span><span class="p">:</span> <span class="n">line_item_validation</span><span class="p">})</span>

        <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

        <span class="n">dt_completed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="n">dt_completed_fmt</span> <span class="o">=</span> <span class="n">dt_completed</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span>

        <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;documents&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">document</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>
            <span class="n">document</span><span class="p">[</span><span class="s1">&#39;complete_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_completed_fmt</span>

            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pages&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">page</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>

            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;document_fields&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">field</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>

            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">cell</span>
                <span class="k">for</span> <span class="n">document_table</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;document_tables&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">document_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rows&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cells&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">]:</span>
                <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unassigned_pages&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">page</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;state&#39;</span> <span class="ow">in</span> <span class="n">submission</span><span class="p">:</span>
            <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;complete_time&#39;</span> <span class="ow">in</span> <span class="n">submission</span><span class="p">:</span>
            <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;complete_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_completed_fmt</span>

        <span class="k">return</span> <span class="n">submission</span>

    <span class="c1"># Custom code block enables users to transform and validate extracted submission data</span>
    <span class="c1"># before Hyperscience sends it to downstream systems</span>
    <span class="c1"># In this example, user created a _mark_as_completed function to transform and validate</span>
    <span class="c1"># submission data</span>
    <span class="c1"># Notice that the _mark_as_completed function takes in a single argument which is passed</span>
    <span class="c1"># in using the code_input parameter</span>
    <span class="n">mark_as_complete</span> <span class="o">=</span> <span class="n">CodeBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;mark_as_completed&#39;</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="n">_mark_as_complete</span><span class="p">,</span>
        <span class="n">code_input</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">load_submission</span><span class="o">.</span><span class="n">output</span><span class="p">(),</span>
            <span class="s1">&#39;line_item_validation&#39;</span><span class="p">:</span> <span class="n">line_item_validation</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;line_item_validation&#39;</span><span class="p">)</span>
                    <span class="p">},</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mark As Completed&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Updated Transformed JSON to Completed State&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Submission complete block finalizes submission processing and updates reporting data</span>
    <span class="c1"># Every flow needs a complete block because it initiates Quality Assurance tasks and</span>
    <span class="c1"># changes the submission&#39;s status to &quot;Complete&quot;</span>
    <span class="c1"># In this example, submission complete block receives the submission object from</span>
    <span class="c1"># marked_as_complete custom code block</span>
    <span class="n">submission_complete</span> <span class="o">=</span> <span class="n">SubmissionCompleteBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;complete_submission&#39;</span><span class="p">,</span>
        <span class="n">payload</span><span class="o">=</span><span class="n">mark_as_complete</span><span class="o">.</span><span class="n">output</span><span class="p">(),</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">mark_as_complete</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Output block allows users to send data extracted by this idp flow to other systems</span>
    <span class="c1"># for downstream processing</span>
    <span class="c1"># In this example, this is an empty output block that does not do anything by default</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">IDPOutputsBlock</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.submission&#39;</span><span class="p">)}</span>
    <span class="p">)</span>

    <span class="n">invoice_flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span>
        <span class="c1"># Flows should have a deterministic UUID ensuring cross-system consistency</span>
        <span class="n">uuid</span><span class="o">=</span><span class="n">UUID</span><span class="p">(</span><span class="s1">&#39;749bbcfa-020f-428f-8878-b1206e2a4d79&#39;</span><span class="p">),</span>
        <span class="n">owner_email</span><span class="o">=</span><span class="s1">&#39;chris.card@hyperscience.com&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Line Item Validations&#39;</span><span class="p">,</span>
        <span class="c1"># Flow identifiers are globally unique</span>
        <span class="n">manifest</span><span class="o">=</span><span class="n">IDPManifest</span><span class="p">(</span><span class="n">flow_identifier</span><span class="o">=</span><span class="s1">&#39;LINE_ITEM_VALIDATION&#39;</span><span class="p">),</span>
        <span class="c1"># It is important to include all blocks that are instantiated here in the blocks</span>
        <span class="c1"># field and make sure they follow the order of the flow. For example, if machine</span>
        <span class="c1"># classification depends on the output of case collation, then case_collation must</span>
        <span class="c1"># come before machine_classification in this blocks array</span>
        <span class="n">blocks</span><span class="o">=</span><span class="p">[</span>
            <span class="n">submission_bootstrap</span><span class="p">,</span>
            <span class="n">case_collation</span><span class="p">,</span>
            <span class="n">machine_classification</span><span class="p">,</span>
            <span class="n">manual_classification</span><span class="p">,</span>
            <span class="n">machine_identification</span><span class="p">,</span>
            <span class="n">manual_identification</span><span class="p">,</span>
            <span class="n">machine_transcription</span><span class="p">,</span>
            <span class="n">manual_transcription</span><span class="p">,</span>
            <span class="n">line_item_validation</span><span class="p">,</span>
            <span class="n">flexible_extraction</span><span class="p">,</span>
            <span class="n">load_submission</span><span class="p">,</span>
            <span class="n">mark_as_complete</span><span class="p">,</span>
            <span class="n">submission_complete</span><span class="p">,</span>
            <span class="n">outputs</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">get_idp_wf_inputs</span><span class="p">(</span><span class="n">idp_wf_config</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Perform validation for total invoice amount and for line item quantity, &#39;</span>
        <span class="s1">&#39;unit price, and total price&#39;</span><span class="p">,</span>
        <span class="n">triggers</span><span class="o">=</span><span class="n">IDPTriggers</span><span class="p">(),</span>
        <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission_complete</span><span class="o">.</span><span class="n">output</span><span class="p">()},</span>
    <span class="p">)</span>

    <span class="n">inputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">invoice_flow</span><span class="o">.</span><span class="n">manifest</span><span class="o">.</span><span class="n">input</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">LINE_ITEM_VALIDATION_PARAMETERS</span><span class="p">:</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="n">wf_input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">invoice_flow</span><span class="o">.</span><span class="n">input</span>
    <span class="c1"># avoid mypy error &#39;has no attribute update&#39;</span>
    <span class="k">assert</span> <span class="n">wf_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="n">wf_input</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">CustomSettings</span><span class="o">.</span><span class="n">SkipFlexibleExtraction</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">CustomSettings</span><span class="o">.</span><span class="n">IgnoreLineItemTranscription</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">invoice_flow</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">export_flow</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="n">entry_point_flow</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="pdf-redaction">
<h2>PDF Redaction<a class="headerlink" href="#pdf-redaction" title="Permalink to this headline"></a></h2>
<p>This example allows redaction of fields in a PDF by performing REGEX on fields/segments and blacking out corresponding bounding boxes.</p>
<p><a class="reference download internal" download="" href="../_downloads/eff71ec3b851e59f841e9a7789327f57/pdf_redaction_v32.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">pdf_redaction.zip</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">UUID</span>

<span class="kn">from</span> <span class="nn">flows_sdk.blocks</span> <span class="kn">import</span> <span class="n">CodeBlock</span>
<span class="kn">from</span> <span class="nn">flows_sdk.flows</span> <span class="kn">import</span> <span class="n">Flow</span>
<span class="kn">from</span> <span class="nn">flows_sdk.implementations.idp_v32.idp_blocks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CaseCollationBlock</span><span class="p">,</span>
    <span class="n">FlexibleExtractionBlock</span><span class="p">,</span>
    <span class="n">IDPOutputsBlock</span><span class="p">,</span>
    <span class="n">MachineClassificationBlock</span><span class="p">,</span>
    <span class="n">MachineIdentificationBlock</span><span class="p">,</span>
    <span class="n">MachineTranscriptionBlock</span><span class="p">,</span>
    <span class="n">ManualClassificationBlock</span><span class="p">,</span>
    <span class="n">ManualIdentificationBlock</span><span class="p">,</span>
    <span class="n">ManualTranscriptionBlock</span><span class="p">,</span>
    <span class="n">SubmissionBootstrapBlock</span><span class="p">,</span>
    <span class="n">SubmissionCompleteBlock</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">flows_sdk.implementations.idp_v32.idp_values</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IDPManifest</span><span class="p">,</span>
    <span class="n">IDPTriggers</span><span class="p">,</span>
    <span class="n">get_idp_wf_config</span><span class="p">,</span>
    <span class="n">get_idp_wf_inputs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">flows_sdk.package_utils</span> <span class="kn">import</span> <span class="n">export_flow</span>


<span class="k">def</span> <span class="nf">entry_point_flow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">idp_workflow</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">idp_workflow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">:</span>
    <span class="n">idp_wf_config</span> <span class="o">=</span> <span class="n">get_idp_wf_config</span><span class="p">()</span>

    <span class="c1"># The idp flow basically processes, modifies and propagates the submission object from</span>
    <span class="c1"># block to block</span>
    <span class="c1"># Each block&#39;s processing result is usually included in the submission object</span>

    <span class="c1"># Submission bootstrap block initializes the submission object and prepares external images</span>
    <span class="c1"># or other submission data if needed</span>
    <span class="n">submission_bootstrap</span> <span class="o">=</span> <span class="n">SubmissionBootstrapBlock</span><span class="p">(</span><span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;submission_bootstrap&#39;</span><span class="p">)</span>

    <span class="c1"># Case collation block groups files, documents and pages (from the submission) into cases</span>
    <span class="c1"># In this example, case collation block receives the submission object and the cases</span>
    <span class="c1"># information from submission bootstrap block</span>
    <span class="n">case_collation</span> <span class="o">=</span> <span class="n">CaseCollationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_collation&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.submission&#39;</span><span class="p">),</span>
        <span class="n">cases</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params.cases&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Machine classification block automatically matches documents to structured, semi-structured</span>
    <span class="c1"># or additional layouts</span>
    <span class="c1"># In this example, machine classification block receives the submission object from</span>
    <span class="c1"># case collation block</span>
    <span class="n">machine_classification</span> <span class="o">=</span> <span class="n">MachineClassificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_classification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">case_collation</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Manual classification block allows keyers to manually match submissions to their layouts.</span>
    <span class="c1"># Keyers may perform manual classification if machine classification cannot automatically</span>
    <span class="c1"># match a submission to a layout with high confidence</span>
    <span class="c1"># In this example, manual classification block receives the submission object from machine</span>
    <span class="c1"># classification block</span>
    <span class="n">manual_classification</span> <span class="o">=</span> <span class="n">ManualClassificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_classification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">machine_classification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Machine identification automatically identify fields and tables in the submission</span>
    <span class="c1"># In this example, machine identification block receives the submission object from manual</span>
    <span class="c1"># classification</span>
    <span class="n">machine_identification</span> <span class="o">=</span> <span class="n">MachineIdentificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_identification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">manual_classification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Manual identification allows keyers to complete field identification or table identification</span>
    <span class="c1"># tasks, where they draw bounding boxes around the contents of certain fields, table columns</span>
    <span class="c1"># or table rows. This identification process ensures that the system will be able to</span>
    <span class="c1"># transcribe the correct content in the upcoming transcription process</span>
    <span class="c1"># In this example, manual identification block receives the submission object from machine</span>
    <span class="c1"># identification</span>
    <span class="n">manual_identification</span> <span class="o">=</span> <span class="n">ManualIdentificationBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_identification&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">machine_identification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Machine transcription automatically transcribes the content of your submission</span>
    <span class="c1"># In this example, machine identification block receives the submission object from manual</span>
    <span class="c1"># identification</span>
    <span class="n">machine_transcription</span> <span class="o">=</span> <span class="n">MachineTranscriptionBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;machine_transcription&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">manual_identification</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Manual transcription lets your keyers manually enter the text found in fields or tables</span>
    <span class="c1"># that could not be automatically transcribed</span>
    <span class="c1"># In this example, manual transcription block receives the submission object from machine</span>
    <span class="c1"># transcription block</span>
    <span class="n">manual_transcription</span> <span class="o">=</span> <span class="n">ManualTranscriptionBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_transcription&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">machine_transcription</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="c1"># Flexible extraction manually transcribes fields marked for review</span>
    <span class="c1"># In this example, flexible extraction block receives the submission object from manual</span>
    <span class="c1"># transcription block</span>
    <span class="n">flexible_extraction</span> <span class="o">=</span> <span class="n">FlexibleExtractionBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;flexible_extraction&#39;</span><span class="p">,</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">manual_transcription</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
        <span class="n">api_params</span><span class="o">=</span><span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.api_params&#39;</span><span class="p">),</span>
        <span class="c1"># api_params is some submission processing settings obtained from submission bootstrap</span>
        <span class="c1"># that users do not have to worry about</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_submission</span><span class="p">(</span><span class="n">submission</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">inspect</span>

        <span class="n">submission_id_ref</span> <span class="o">=</span> <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="n">sdm_get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;api/v5/submissions/</span><span class="si">{</span><span class="n">submission_id_ref</span><span class="si">}</span><span class="s1">?flat=False&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="n">load_submission</span> <span class="o">=</span> <span class="n">CodeBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;load_submission&#39;</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="n">_load_submission</span><span class="p">,</span>
        <span class="n">code_input</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">flexible_extraction</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">)},</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Load Submission&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Returns Submission in API v5 Format&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_redact_pdf</span><span class="p">(</span><span class="n">submission</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">inspect</span>
        <span class="kn">import</span> <span class="nn">cv2</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>

        <span class="c1"># pylint: disable=import-error</span>
        <span class="kn">from</span> <span class="nn">blocks.base_python_block</span> <span class="kn">import</span> <span class="n">BlobCreateParams</span>  <span class="c1"># type: ignore</span>
        <span class="kn">from</span> <span class="nn">sdm_image.image_utils.image_read</span> <span class="kn">import</span> <span class="n">blob_to_cv2_image</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># pylint: enable=import-error</span>

        <span class="n">proxy</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;documents&#39;</span><span class="p">]:</span>
                <span class="n">images_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s1">&#39;pages&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">page</span><span class="p">[</span><span class="s1">&#39;corrected_image_url&#39;</span><span class="p">]:</span>
                        <span class="n">image_url_parts</span> <span class="o">=</span> <span class="n">page</span><span class="p">[</span><span class="s1">&#39;corrected_image_url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                        <span class="n">image_blob</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="n">fetch_blob</span><span class="p">(</span><span class="n">image_url_parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">content</span>
                        <span class="n">cv2_image</span> <span class="o">=</span> <span class="n">blob_to_cv2_image</span><span class="p">(</span><span class="n">image_blob</span><span class="p">)</span>
                        <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2_image</span><span class="o">.</span><span class="n">shape</span>

                        <span class="n">rect_points</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="c1"># Process Fields</span>
                        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s1">&#39;document_fields&#39;</span><span class="p">]:</span>
                            <span class="n">start_x</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">start_y</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">end_x</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">end_y</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;page_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">page</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;output_name&#39;</span><span class="p">]</span> <span class="ow">and</span>
                                                                   <span class="s1">&#39;REDACT_&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">[</span>
                                                                       <span class="s1">&#39;output_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
                                <span class="n">url</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;field_image_url&#39;</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
                                    <span class="n">params</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
                                    <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                    <span class="n">coords</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
                                        <span class="n">pair</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">start_x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                            <span class="n">start_y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                            <span class="n">end_x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                            <span class="n">end_y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                                    <span class="k">if</span> <span class="n">start_x</span> <span class="ow">and</span> <span class="n">start_y</span> <span class="ow">and</span> <span class="n">end_x</span> <span class="ow">and</span> <span class="n">end_y</span><span class="p">:</span>
                                        <span class="n">start_point</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">start_x</span><span class="p">),</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">start_y</span><span class="p">),</span>
                                        <span class="p">)</span>
                                        <span class="n">end_point</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">end_x</span><span class="p">),</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">end_y</span><span class="p">),</span>
                                        <span class="p">)</span>

                                        <span class="n">rect_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_point</span><span class="p">,</span> <span class="n">end_point</span><span class="p">))</span>

                        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s1">&#39;document_tables&#39;</span><span class="p">]:</span>
                            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]:</span>
                                <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;cells&#39;</span><span class="p">]:</span>
                                    <span class="n">start_x</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">start_y</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">end_x</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">end_y</span> <span class="o">=</span> <span class="kc">None</span>

                                    <span class="k">if</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;page_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">page</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span>
                                            <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;REDACT&#39;</span> <span class="ow">in</span> <span class="n">cell</span><span class="p">[</span>
                                        <span class="s1">&#39;column_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
                                        <span class="n">start_x</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;bounding_box&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="n">start_y</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;bounding_box&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                                        <span class="n">end_x</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;bounding_box&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                                        <span class="n">end_y</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;bounding_box&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

                                        <span class="k">if</span> <span class="n">start_x</span> <span class="ow">and</span> <span class="n">start_y</span> <span class="ow">and</span> <span class="n">end_x</span> <span class="ow">and</span> <span class="n">end_y</span><span class="p">:</span>
                                            <span class="n">start_point</span> <span class="o">=</span> <span class="p">(</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">start_x</span><span class="p">),</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">start_y</span><span class="p">),</span>
                                            <span class="p">)</span>
                                            <span class="n">end_point</span> <span class="o">=</span> <span class="p">(</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">end_x</span><span class="p">),</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">end_y</span><span class="p">),</span>
                                            <span class="p">)</span>

                                            <span class="n">rect_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_point</span><span class="p">,</span> <span class="n">end_point</span><span class="p">))</span>

                        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">rect_points</span><span class="p">:</span>
                            <span class="n">cv2_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
                                <span class="n">cv2_image</span><span class="p">,</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="p">,</span> <span class="n">thickness</span>
                            <span class="p">)</span>

                        <span class="n">tmp_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span>
                        <span class="n">tmp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imencode</span><span class="p">(</span><span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="n">cv2_image</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
                        <span class="n">tmp_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">fsync</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
                        <span class="n">images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">images_list</span><span class="p">:</span>
                    <span class="n">images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">())</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tiffcp&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">image_file</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="n">images_list</span><span class="p">]]</span>

                    <span class="n">run_result_join</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                        <span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">run_result_join</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                        <span class="c1"># submission[&#39;exceptions&#39;]</span>
                        <span class="k">return</span> <span class="n">submission</span>

                    <span class="n">images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">())</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tiff2pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">images_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;-F&#39;</span><span class="p">,</span> <span class="n">images_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

                    <span class="n">run_result_pdf</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                        <span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">run_result_pdf</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                        <span class="c1"># submission[&#39;exceptions&#39;]</span>
                        <span class="k">return</span> <span class="n">submission</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">images_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">blob_file</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="n">store_blob</span><span class="p">(</span>
                            <span class="n">BlobCreateParams</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;document_</span><span class="si">{}</span><span class="s1">_redacted_pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">document</span><span class="p">[</span>
                                                                                        <span class="s1">&#39;id&#39;</span><span class="p">]),</span>
                                             <span class="n">content</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                        <span class="p">)</span>

                    <span class="n">document</span><span class="p">[</span><span class="s1">&#39;redacted_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/api/block_storage/</span><span class="si">{}</span><span class="s1">/download&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">blob_file</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="n">images_list</span><span class="p">:</span>
                <span class="n">image_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">submission</span>

    <span class="n">redact_pdf</span> <span class="o">=</span> <span class="n">CodeBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;redact_pdf&#39;</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="n">_redact_pdf</span><span class="p">,</span>
        <span class="n">code_input</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">load_submission</span><span class="o">.</span><span class="n">output</span><span class="p">()},</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Redact PDF&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Redact a PDF based on field configuration&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mark_as_completed</span><span class="p">(</span><span class="n">submission</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

        <span class="n">dt_completed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="n">dt_completed_fmt</span> <span class="o">=</span> <span class="n">dt_completed</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span>

        <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;documents&#39;</span><span class="p">]:</span>
            <span class="n">document</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>
            <span class="n">document</span><span class="p">[</span><span class="s1">&#39;complete_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_completed_fmt</span>

            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">document</span><span class="p">[</span><span class="s1">&#39;pages&#39;</span><span class="p">]:</span>
                <span class="n">page</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;unassigned_pages&#39;</span><span class="p">]:</span>
            <span class="n">page</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>

        <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>
        <span class="n">submission</span><span class="p">[</span><span class="s1">&#39;complete_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_completed_fmt</span>

        <span class="k">return</span> <span class="n">submission</span>

    <span class="c1"># Custom code block enables users to transform and validate extracted submission data</span>
    <span class="c1"># before Hyperscience sends it to downstream systems</span>
    <span class="c1"># In this example, user created a _mark_as_completed function to transform and validate</span>
    <span class="c1"># submission data</span>
    <span class="c1"># Notice that the _mark_as_completed function takes in a single argument which is passed</span>
    <span class="c1"># in using the code_input parameter</span>
    <span class="n">mark_as_complete</span> <span class="o">=</span> <span class="n">CodeBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;mark_as_completed&#39;</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="n">_mark_as_completed</span><span class="p">,</span>
        <span class="n">code_input</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">redact_pdf</span><span class="o">.</span><span class="n">output</span><span class="p">()},</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mark As Completed&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Updated Transformed JSON to Completed State&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Submission complete block finalizes submission processing and updates reporting data</span>
    <span class="c1"># Every flow needs a complete block because it initiates Quality Assurance tasks and</span>
    <span class="c1"># changes the submission&#39;s status to &quot;Complete&quot;</span>
    <span class="c1"># In this example, submission complete block receives the submission object from</span>
    <span class="c1"># marked_as_complete custom code block</span>
    <span class="n">submission_complete</span> <span class="o">=</span> <span class="n">SubmissionCompleteBlock</span><span class="p">(</span>
        <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;complete_submission&#39;</span><span class="p">,</span>
        <span class="n">payload</span><span class="o">=</span><span class="n">mark_as_complete</span><span class="o">.</span><span class="n">output</span><span class="p">(),</span>
        <span class="n">submission</span><span class="o">=</span><span class="n">mark_as_complete</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Output block allows users to send data extracted by this idp flow to other systems</span>
    <span class="c1"># for downstream processing</span>
    <span class="c1"># In this example, this is an empty output block that does not do anything by default</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">IDPOutputsBlock</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission_bootstrap</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;result.submission&#39;</span><span class="p">)}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">Flow</span><span class="p">(</span>
        <span class="c1"># Flows should have a deterministic UUID ensuring cross-system consistency</span>
        <span class="n">uuid</span><span class="o">=</span><span class="n">UUID</span><span class="p">(</span><span class="s1">&#39;9174f4b5-2809-4a09-a25c-18b870b94945&#39;</span><span class="p">),</span>
        <span class="n">owner_email</span><span class="o">=</span><span class="s1">&#39;chris.card@hyperscience.com&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;PDF Redaction (Field Based)&#39;</span><span class="p">,</span>
        <span class="c1"># Flow identifiers are globally unique</span>
        <span class="n">manifest</span><span class="o">=</span><span class="n">IDPManifest</span><span class="p">(</span><span class="n">flow_identifier</span><span class="o">=</span><span class="s1">&#39;PDF_REDACTION_FIELD_BASED&#39;</span><span class="p">),</span>
        <span class="c1"># It is important to include all blocks that are instantiated here in the blocks</span>
        <span class="c1"># field and make sure they follow the order of the flow. For example, if machine</span>
        <span class="c1"># classification depends on the output of case collation, then case_collation must</span>
        <span class="c1"># come before machine_classification in this blocks array</span>
        <span class="n">blocks</span><span class="o">=</span><span class="p">[</span>
            <span class="n">submission_bootstrap</span><span class="p">,</span>
            <span class="n">case_collation</span><span class="p">,</span>
            <span class="n">machine_classification</span><span class="p">,</span>
            <span class="n">manual_classification</span><span class="p">,</span>
            <span class="n">machine_identification</span><span class="p">,</span>
            <span class="n">manual_identification</span><span class="p">,</span>
            <span class="n">machine_transcription</span><span class="p">,</span>
            <span class="n">manual_transcription</span><span class="p">,</span>
            <span class="n">flexible_extraction</span><span class="p">,</span>
            <span class="n">load_submission</span><span class="p">,</span>
            <span class="n">redact_pdf</span><span class="p">,</span>
            <span class="n">mark_as_complete</span><span class="p">,</span>
            <span class="n">submission_complete</span><span class="p">,</span>
            <span class="n">outputs</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">get_idp_wf_inputs</span><span class="p">(</span><span class="n">idp_wf_config</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;PDF Redaction based on Field Configuration&#39;</span><span class="p">,</span>
        <span class="n">triggers</span><span class="o">=</span><span class="n">IDPTriggers</span><span class="p">(),</span>
        <span class="n">output</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">submission_complete</span><span class="o">.</span><span class="n">output</span><span class="p">()},</span>
    <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">export_flow</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="n">entry_point_flow</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="code-snippets">
<h2>Code Snippets<a class="headerlink" href="#code-snippets" title="Permalink to this headline"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While code snippets are great, the Hyperscience Platform provides easy tools to help you build your own solutions. Make sure to read our Testing &amp; Debugging guide below before diving in.</p>
</div>
<section id="how-do-i-iterate-over-multiple-documents-in-a-submission">
<h3>How do I iterate over multiple documents in a submission?<a class="headerlink" href="#how-do-i-iterate-over-multiple-documents-in-a-submission" title="Permalink to this headline"></a></h3>
<p>Block subclasses provided in the <a class="reference internal" href="idp_32.html#processing-blocks"><span class="std std-ref">Processing Blocks</span></a> generally take a Submission object as a mandatory input parameter as well as output a modified copy of the Submission object. Each block provides a convenience method to access the Submission object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This example shows the output of MachineTranscriptionV3Block (i.e. machine_transcription) being used as the input to a ManualTranscriptionV2Block</span>
<span class="n">manual_transcription</span> <span class="o">=</span> <span class="n">ManualTranscriptionV2Block</span><span class="p">(</span>
  <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;manual_transcription&#39;</span><span class="p">,</span>
  <span class="n">submission</span><span class="o">=</span><span class="n">machine_transcription</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">),</span>
  <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Always check the exact output of the preceding block! Some block output includes additional metadata and may require a different key, such as <cite>.output(‘results.submission’)</cite>, to access the Submission object.</p>
</div>
<p>The Submission object is constructed as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;submission&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;12345&quot;</span><span class="p">,</span>
      <span class="s2">&quot;documents&quot;</span><span class="p">:</span> <span class="p">[</span>
         <span class="p">{</span>
             <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
             <span class="s2">&quot;pages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">//</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">pages</span>
             <span class="s2">&quot;document_fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">//</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">document</span> <span class="n">fields</span>
         <span class="p">},</span>
         <span class="o">...</span>
      <span class="p">]</span>
      <span class="s2">&quot;cases&quot;</span><span class="p">:</span> <span class="p">[],</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And so iterating over multiple documents in a submission is as easy as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_iter_docs</span><span class="p">(</span><span class="n">submission</span><span class="p">):</span>
   <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;documents&#39;</span><span class="p">,</span> <span class="p">[]):</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="c1"># Print the ID of each document in the submission</span>
   <span class="k">return</span> <span class="n">submission</span>

<span class="n">custom_code</span> <span class="o">=</span> <span class="n">CodeBlock</span><span class="p">(</span>
   <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;code_block&#39;</span><span class="p">,</span>
   <span class="n">code</span><span class="o">=</span><span class="n">_iter_docs</span><span class="p">,</span>
   <span class="n">code_input</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">manual_transcription</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">)}</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="how-do-i-compare-fields-across-different-documents">
<h3>How do I compare fields across different documents?<a class="headerlink" href="#how-do-i-compare-fields-across-different-documents" title="Permalink to this headline"></a></h3>
<p>Let’s assume we’re trying to find the maximum value of the “income” field across multiple documents in the same submission. Once transcribed, we iterate over all the transcribed fields in the submission and compare each value to the previous maximum:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_compare_fields</span><span class="p">(</span><span class="n">submission</span><span class="p">):</span>
   <span class="n">max_income</span> <span class="o">=</span> <span class="mf">0.0</span>
   <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;documents&#39;</span><span class="p">,</span> <span class="p">[]):</span>
      <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;document_fields&#39;</span><span class="p">,</span> <span class="p">[]):</span>
         <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;field_name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;income&#39;</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transcription&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">max_income</span><span class="p">:</span>
            <span class="n">max_income</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transcription&#39;</span><span class="p">))</span>

      <span class="nb">print</span><span class="p">(</span><span class="n">max_income</span><span class="p">)</span> <span class="c1"># Print the maximum income across all documents</span>
   <span class="k">return</span> <span class="n">submission</span>

<span class="n">custom_code</span> <span class="o">=</span> <span class="n">CodeBlock</span><span class="p">(</span>
   <span class="n">reference_name</span><span class="o">=</span><span class="s1">&#39;code_block&#39;</span><span class="p">,</span>
   <span class="n">code</span><span class="o">=</span><span class="n">_compare_fields</span><span class="p">,</span>
   <span class="n">code_input</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;submission&#39;</span><span class="p">:</span> <span class="n">previous_block</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;submission&#39;</span><span class="p">)}</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tutorial.html" class="btn btn-neutral float-left" title="Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="custom_supervision.html" class="btn btn-neutral float-right" title="Custom Supervision" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Hyperscience.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>